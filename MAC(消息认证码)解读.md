# MAC(消息认证码)解读



## 背景

在开放的计算和通信世界（例如Internet）中，我们会使用不可靠的媒介传输和存储信息。而对信息完整性（integrity）的校验在某些情景下就十分重要。基于密钥作完整性校验的方法常称为MAC(Message Authentication Code)。通常MAC在共享密钥的双方之间，校验相互传递的信息。

## 实现过程

使用 MAC 验证消息完整性的具体过程是：假设通信双方 A 和 B 共享密钥 K，A用消息认证码算法将 K 和消息 M 计算出消息验证码 Mac，然后将 Mac 和 M 一起发送给 B。B 接收到 Mac 和 M 后，利用 M 和 K 计算出新的验证码 Mac*，若 Mac*和Mac 相等则验证成功，证明消息未被篡改。由于攻击者没有密钥 K，攻击者修改了消息内容后无法计算出相应的消息验证码，因此 B 就能够发现消息完整性遭到破坏。



## 类别

消息认证码（MAC）,在加密的过程中有两种方法，一种是用单向散列函数的实现，另一种是分组密码的实现。



## 单向散列函数实现



![170101_Zo2o_1469576](/Users/liuyijiang/Downloads/170101_Zo2o_1469576.png)

用单向hsah函数加密的消息认证码又被称为HMAC(Hash Message Authentication Code),如上图所示，实现过程较为简单对要传输的消息加上一个通信双方共享的密钥，然后作一次hash运算，得到一个MAC值。传输消息时，连同MAC值一起发送给接收放，接收方收到信息后，自己再对信息作一次相同的hash运算得到另一个MAC值，与发送方传来的进行比对，若有差异则说明消息被篡改。

## 分组密码实现（基于AES组）

**AES(Advanced Encryption Standard)**，高级加密标准，是一种十分常见的对成加密算法。(ps:微信小程序加密传输就是用的AES加密算法)

分组加密的工作模式有ECB,CBC,CFB,OFB四种，其中CBC和ECB这两种模式比较常用。

**ECB (Electronic codebook)  ,电子密码本模式** 

![Image text](https://raw.githubusercontent.com/weixiao619/mycode/master/image/1ECB.jpg)

**优点：**

1.简单；

2.有利于并行计算；

3.误差不会被传送；

**缺点：**

1.不能隐藏明文的模式；

2.可能对明文进行主动攻击；

**CBC(Clipher-block chaining )，密码分组链接模式** 

![2CBC](https://github.com/weixiao619/mycode/tree/master/image/2CBC.jpg)

图中IV为初始化向量。

**优点：**

1.不容易主动攻击，安全性好于ECB,适合传输长报文，是SSL,IPSec的标准

**缺点：**

1.不利于并行计算；

2.误差传递；



当取AES作为加密的分组密码时，称为基于AES的CBC-MAC,若需要产生认证码的消息为x，加密的AES密钥为k，则生成加解密的过程如下图所示

![image-20181107204036868](https://github.com/weixiao619/mycode/tree/master/image/cbce.png)



![FB8E2A6A3FBB60FDFED5004F2240B7FF](https://github.com/weixiao619/mycode/tree/master/image/cbcd.png)



上图分别为CBC(密文分组链接方式)的加密和解密过程。可以看出不同于EBC(电子密码本模式)，他在加密过程中，报文的不同分组之间是有联系的，增加了其安全性。

**加密**步骤如下：

1）首先将数据按照8个字节一组进行分组得到D1D2......Dn（若数据不是8的整数倍，用指定的PADDING数据补位）

2）第一组数据D1与初始化向量IV异或后的结果进行AES加密得到第一组密文C1（初始化向量I为全零）

3）第二组数据D2与第一组的加密结果C1异或以后的结果进行DES加密，得到第二组密文C2

4）之后的数据以此类推，得到Cn

5）按顺序连为C1C2C3......Cn即为加密结果。

**解密**是加密的逆过程，步骤如下：

1）首先将数据按照8个字节一组进行分组得到C1C2C3......Cn

2）将第一组数据进行解密后与初始化向量I进行异或得到第一组明文D1（注意：一定是先解密再异或）

3）将第二组数据C2进行解密后与第一组密文数据进行异或得到第二组数据D2

4）之后依此类推，得到Dn

5）按顺序连为D1D2D3......Dn即为解密结果。

这里注意一点，解密的结果并不一定是我们原来的加密数据，可能还含有补位数据，将其去掉才是最终的结果。

**特点：** 

1.每个密文块依赖于所有的信息块，明文消息中一个改变会影响所有密文块，不容易主动攻击，安全性好于ECB,适合传输长报文

2.发送方和接受方都需要知道初始化向量（IV）

3.加密过程是串行的，无法被并行化（在解密时，从两个邻接的密文块可以得到一个平文块，因此解密过程可以并行执行）

